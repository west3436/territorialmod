name: Build Mod

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/build'))
    
    permissions:
      contents: read
      actions: write
      pull-requests: read
    
    steps:
      - name: Check if build should proceed
        id: should_build
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('proceed', 'true');
              return;
            }
            
            // For issue_comment events, check permissions
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor
              });
              
              const hasPermission = ['admin', 'write', 'maintain'].includes(permission.permission);
              
              if (!hasPermission) {
                core.setFailed(`User ${context.actor} does not have permission to trigger builds`);
                core.setOutput('proceed', 'false');
                return;
              }
              
              core.setOutput('proceed', 'true');
            } catch (error) {
              core.setFailed(`Error checking permissions: ${error.message}`);
              core.setOutput('proceed', 'false');
            }
      
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        if: github.event_name == 'issue_comment' && steps.should_build.outputs.proceed == 'true'
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pullRequest.head.ref);
            core.setOutput('sha', pullRequest.head.sha);
            core.setOutput('number', pullRequest.number.toString());
      
      - name: Checkout code
        uses: actions/checkout@v4
        if: steps.should_build.outputs.proceed == 'true'
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.sha || github.event.pull_request.head.sha }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        if: steps.should_build.outputs.proceed == 'true'
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        if: steps.should_build.outputs.proceed == 'true'
        run: chmod +x gradlew
      
      - name: Build mod with Gradle
        if: steps.should_build.outputs.proceed == 'true'
        run: ./gradlew build --no-daemon --stacktrace
      
      - name: Find built JAR
        id: find_jar
        if: steps.should_build.outputs.proceed == 'true'
        run: |
          JAR_PATH=$(find build/libs -name "*.jar" ! -name "*-sources.jar" | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "Error: No JAR file found in build/libs"
            exit 1
          fi
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        if: steps.should_build.outputs.proceed == 'true'
        with:
          name: mod-build-${{ github.event_name == 'issue_comment' && steps.pr.outputs.number || github.event.pull_request.number }}
          path: ${{ steps.find_jar.outputs.jar_path }}
          retention-days: 30
