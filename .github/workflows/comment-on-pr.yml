name: Comment on PR

on:
  workflow_run:
    workflows: ["Build Mod"]
    types:
      - completed

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      (github.event.workflow_run.event == 'pull_request' || github.event.workflow_run.event == 'issue_comment') &&
      (github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure')
    
    permissions:
      contents: read
      pull-requests: write
      actions: read
    
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const headRepo = context.payload.workflow_run.head_repository;
            const headOwner = headRepo ? headRepo.owner.login : context.repo.owner;
            
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${headOwner}:${context.payload.workflow_run.head_branch}`
            });
            
            if (pullRequests.length === 0) {
              console.log('No open PR found for this branch');
              return;
            }
            
            const prNumber = pullRequests[0].number;
            core.setOutput('pr_number', prNumber.toString());
      
      - name: Get artifact details
        id: artifact
        if: steps.pr.outputs.pr_number && github.event.workflow_run.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            if (artifacts.data.artifacts.length > 0) {
              const artifact = artifacts.data.artifacts[0];
              core.setOutput('artifact_name', artifact.name);
              return artifact.name;
            }
            return '';
      
      - name: Post comment to PR
        if: steps.pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.pr_number }}', 10);
            const buildStatus = '${{ github.event.workflow_run.conclusion }}';
            const runId = context.payload.workflow_run.id;
            const sha = context.payload.workflow_run.head_sha;
            const artifactName = '${{ steps.artifact.outputs.artifact_name }}';
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;
            
            let commentBody = '';
            
            if (buildStatus === 'success') {
              commentBody = `## ‚úÖ Build succeeded\n\n`;
              commentBody += `**Commit:** ${sha.substring(0, 7)}\n`;
              commentBody += `**Workflow Run:** [View Details](${artifactUrl})\n\n`;
              commentBody += `### üì¶ Build Artifact\n\n`;
              commentBody += `The mod has been successfully built!\n\n`;
              if (artifactName) {
                commentBody += `**Artifact:** \`${artifactName}\`\n\n`;
              }
              commentBody += `[Download Build Artifact](${artifactUrl}#artifacts)\n\n`;
              commentBody += `> The artifact will be available for 30 days.\n`;
            } else {
              // Build failed
              commentBody = `## ‚ùå Build failed\n\n`;
              commentBody += `**Commit:** ${sha.substring(0, 7)}\n`;
              commentBody += `**Workflow Run:** [View Details](${artifactUrl})\n\n`;
              commentBody += `### ‚ùå Build Failed\n\n`;
              commentBody += `The build encountered errors. Please check the [workflow logs](${artifactUrl}) for details.\n`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
